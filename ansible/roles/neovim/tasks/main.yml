---
# =========================
# Neovim role
# =========================

# -------------------------
# Ensure ~/.local/bin exists
# -------------------------
- name: Ensure local bin directory exists
  file:
    path: "{{ user_home }}/.local/bin"
    state: directory
    mode: "0755"
  tags: [neovim, vim]

# -------------------------
# Linux: select correct AppImage
# -------------------------
- name: Select Neovim AppImage (Linux)
  set_fact:
    neovim_appimage_name: >-
      {{
        neovim_appimage_arm64
        if ansible_architecture in ['aarch64', 'arm64']
        else neovim_appimage_x86_64
      }}
  when: ansible_os_family != "Darwin"
  tags: [neovim]

# -------------------------
# Linux: install latest Neovim (AppImage)
# -------------------------
- name: Install latest Neovim (Linux AppImage)
  get_url:
    url: "{{ neovim_appimage_base_url }}/{{ neovim_appimage_name }}"
    dest: "{{ neovim_install_path }}"
    mode: "0755"
  when: ansible_os_family != "Darwin"
  tags: [neovim]

# -------------------------
# macOS: install latest Neovim via Homebrew
# -------------------------
- name: Install Neovim on macOS
  homebrew:
    name: neovim
    state: latest
  when: ansible_os_family == "Darwin"
  tags: [neovim]

# -------------------------
# Stow Neovim config
# -------------------------
- name: Stow Neovim config
  command: stow nvim
  args:
    chdir: "{{ dotfiles_dir }}"
  changed_when: false
  tags: [neovim]

# -------------------------
# Install Neovim plugins (Lazy.nvim)
# -------------------------
- name: Install Neovim plugins
  command: "{{ neovim_install_path }} --headless '+Lazy! sync' +qa"
  changed_when: false
  tags: [neovim]

# -------------------------
# macOS: detect Homebrew Neovim path
# -------------------------
- name: Detect Homebrew Neovim path (macOS)
  set_fact:
    macos_nvim_path: >-
      {{
        macos_nvim_path_arm
        if ansible_architecture == 'arm64'
        else macos_nvim_path_intel
      }}
  when: ansible_os_family == "Darwin"
  tags: [neovim, vim]

- name: Check if Neovim binary exists
  stat:
    path: "{{ neovim_install_path }}"
  register: nvim_bin
  changed_when: false
  tags: [neovim, vim]

- name: Fail if Neovim binary does not exist
  fail:
    msg: "Neovim binary not found at {{ neovim_install_path }}"
  when: not nvim_bin.stat.exists
  tags: [neovim, vim]

- name: Create vi/vim to nvim symlinks
  file:
    src: "{{ neovim_install_path }}"
    dest: "{{ user_home }}/.local/bin/{{ item }}"
    state: link
    force: true
  loop:
    - vi
    - vim
  tags: [neovim, vim]

- name: Verify vim symlink exists
  stat:
    path: "{{ user_home }}/.local/bin/vim"
  register: vim_shim
  changed_when: false
  tags: [neovim, vim]

- name: Fail if vim symlink was not created
  fail:
    msg: "vim symlink was not created even though nvim exists"
  when: not vim_shim.stat.exists
  tags: [neovim, vim]

# -------------------------
# Verify Neovim installation
# -------------------------
- name: Verify Neovim version
  command: "{{ neovim_install_path }} --version"
  register: nvim_version
  changed_when: false
  tags: [neovim]
